<script>
    document.addEventListener('DOMContentLoaded', () => {
        Chart.register(ChartDataLabels);

        const vibrantPalette = {
            coral: '#FF6F61',
            sunglow: '#FFD166',
            caribbeanGreen: '#06D6A0',
            blueNCS: '#118AB2',
            midnightGreen: '#073B4C',
            lightGray: '#f8f9fa'
        };

        const chartTooltipConfig = {
            plugins: {
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            const item = tooltipItems[0];
                            let label = item.chart.data.labels[item.dataIndex];
                            if (Array.isArray(label)) {
                                return label.join(' ');
                            }
                            return label;
                        }
                    }
                }
            }
        };

        function wrapText(str, maxWidth = 16) {
            if (!str || str.length <= maxWidth) {
                return str;
            }
            const words = str.split(' ');
            if (words.length === 1) return str;
            const lines = [];
            let currentLine = words[0];

            for (let i = 1; i < words.length; i++) {
                if ((currentLine + ' ' + words[i]).length > maxWidth) {
                    lines.push(currentLine);
                    currentLine = words[i];
                } else {
                    currentLine += ' ' + words[i];
                }
            }
            lines.push(currentLine);
            return lines;
        }

        const chartDefaultOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                ...chartTooltipConfig.plugins,
                legend: { position: 'bottom' },
            },
            scales: {
                x: { ticks: { font: { family: "'Inter', 'Noto Sans JP', sans-serif" } } },
                y: { ticks: { font: { family: "'Inter', 'Noto Sans JP', sans-serif" } } }
            }
        };

        const centerTextPlugin = {
            id: 'centerText',
            afterDraw: function(chart) {
                if (chart.config.options.plugins.centerText && chart.config.options.plugins.centerText.display === true) {
                    let ctx = chart.ctx;
                    ctx.save();
                    let fontStyle = chart.config.options.plugins.centerText.font;
                    let textColor = chart.config.options.plugins.centerText.color;
                    let text = chart.config.options.plugins.centerText.text;

                    let centerX = (chart.chartArea.left + chart.chartArea.right) / 2;
                    let centerY = (chart.chartArea.top + chart.chartArea.bottom) / 2;

                    ctx.font = fontStyle;
                    ctx.fillStyle = textColor;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(text, centerX, centerY);
                    ctx.restore();
                }
            }
        };
        Chart.register(centerTextPlugin);

        new Chart(document.getElementById('genderPayGapChart'), {
            type: 'bar',
            data: {
                labels: ['韓国', '日本', 'OECD平均'],
                datasets: [{
                    label: '男女間賃金格差 (%)',
                    data: [31.2, 21.3, 12.1],
                    backgroundColor: [vibrantPalette.coral, vibrantPalette.sunglow, vibrantPalette.blueNCS],
                }]
            },
            options: { ...chartDefaultOptions, indexAxis: 'y', plugins: { ...chartDefaultOptions.plugins, legend: { display: false }, datalabels: {color: '#374151', anchor: 'end', align: 'end', formatter: (value) => value + '%'} } }
        });

        new Chart(document.getElementById('chaebolDominanceChart'), {
            type: 'doughnut',
            data: {
                labels: ['上位10大財閥の売上高', 'その他'],
                datasets: [{ data: [70, 30], backgroundColor: [vibrantPalette.midnightGreen, '#e5e7eb'], borderWidth: 4, borderColor: '#ffffff' }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    ...chartTooltipConfig.plugins,
                    legend: { position: 'bottom' },
                    datalabels: {
                        font: { weight: 'bold', size: 16 },
                        formatter: (value) => value + '%',
                        color: (context) => context.dataIndex === 0 ? '#ffffff' : vibrantPalette.midnightGreen
                    },
                    centerText: {
                        display: true,
                        text: 'GDP',
                        color: vibrantPalette.midnightGreen,
                        font: "900 24px 'Inter', 'Noto Sans JP', sans-serif"
                    }
                }
            }
        });

        new Chart(document.getElementById('laborMarketChart'), {
            type: 'bar',
            data: {
                labels: [['韓国(男性)'], ['韓国(女性)'], ['日本(男性)'], ['日本(女性)']],
                datasets: [
                    { label: '正規職', data: [69, 53, 78, 46], backgroundColor: vibrantPalette.blueNCS, stack: 'Stack 0' },
                    { label: '非正規職', data: [31, 47, 22, 54], backgroundColor: vibrantPalette.coral, stack: 'Stack 0' }
                ]
            },
            options: { ...chartDefaultOptions, plugins: { ...chartDefaultOptions.plugins, datalabels: { color: '#ffffff', formatter: (value) => value + '%' } }, scales: { x: { stacked: true }, y: { stacked: true, title: { display: true, text: '雇用形態 (%)' } } } }
        });

        new Chart(document.getElementById('wageDisparityChart'), {
            type: 'bar',
            data: {
                labels: ['韓国', 'EU平均', '日本'],
                datasets: [{
                    label: '中小企業の賃金水準（対大企業比, %）',
                    data: [57.7, 65.1, 73.7],
                    backgroundColor: [vibrantPalette.coral, vibrantPalette.sunglow, vibrantPalette.caribbeanGreen],
                }]
            },
            options: { ...chartDefaultOptions, plugins: { ...chartDefaultOptions.plugins, legend: { display: false }, datalabels: {color: '#374151', anchor: 'end', align: 'top', formatter: (value) => value + '%'} } , scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: '中小企業の賃金水準（対大企業比, %）' } } } }
        });


        new Chart(document.getElementById('glassCeilingChart'), {
            type: 'bar',
            data: {
                labels: ['韓国', '日本', 'OECD平均'],
                datasets: [{
                    label: '女性管理職比率 (%)',
                    data: [16.3, 13.2, 34.2],
                    backgroundColor: [vibrantPalette.coral, vibrantPalette.sunglow, vibrantPalette.caribbeanGreen]
                }]
            },
            options: { ...chartDefaultOptions, plugins: { ...chartDefaultOptions.plugins, legend: { display: false }, datalabels: {color: '#374151', anchor: 'end', align: 'top', formatter: (value) => value + '%'} } , scales: { y: { beginAtZero: true, max: 40, title: { display: true, text: '女性管理職比率 (%)' } } } }
        });

        new Chart(document.getElementById('mCurveChart'), {
            type: 'line',
            data: {
                labels: ['20-24', '25-29', '30-34', '35-39', '40-44', '45-49'],
                datasets: [{
                    label: '女性',
                    data: [62, 72, 60, 58, 65, 66],
                    borderColor: vibrantPalette.coral,
                    backgroundColor: 'rgba(255, 111, 97, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: '男性',
                    data: [71, 90, 95, 96, 96, 95],
                    borderColor: vibrantPalette.blueNCS,
                    backgroundColor: 'rgba(17, 138, 178, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                ...chartDefaultOptions,
                plugins: {
                    ...chartDefaultOptions.plugins,
                    datalabels: { display: false }
                },
                scales: {
                    y: {
                        min: 50,
                        max: 100,
                        title: { display: true, text: '労働力率 (%)' }
                    }
                }
            }
        });

        new Chart(document.getElementById('backlashChart'), {
            type: 'doughnut',
            data: {
                labels: [wrapText('「逆差別がある」と感じる'), 'そう感じない'],
                datasets: [{
                    data: [79, 21],
                    backgroundColor: [vibrantPalette.coral, '#e5e7eb'],
                    borderWidth: 4,
                    borderColor: '#ffffff'
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, cutout: '60%', plugins: { ...chartTooltipConfig.plugins, datalabels: { color: (ctx) => ctx.dataIndex === 0 ? '#ffffff' : '#374151', formatter: (value) => value + '%' } } }
        });

        new Chart(document.getElementById('brainDrainChart'), {
            type: 'line',
            data: {
                labels: ['2012', '2014', '2016', '2018', '2020', '2022'],
                datasets: [{
                    label: '韓国',
                    data: [1.8, 2.1, 2.4, 2.7, 2.8, 3.1],
                    borderColor: vibrantPalette.midnightGreen,
                    backgroundColor: 'rgba(7, 59, 76, 0.1)',
                    fill: true,
                    tension: 0.1
                },
                {
                    label: '日本',
                    data: [0.15, 0.16, 0.17, 0.18, 0.18, 0.19],
                    borderColor: vibrantPalette.sunglow,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.1
                }]
            },
            options: { ...chartDefaultOptions, plugins: { ...chart
